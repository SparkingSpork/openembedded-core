From 3d3ef1517024850d5db371711e22934f428cba94 Mon Sep 17 00:00:00 2001
From: Jonathan David <jonathan.david@ni.com>
Date: Wed, 24 Feb 2016 11:15:55 -0600
Subject: [PATCH] ConnectionExists: for NTLM re-use, require credentials to
 match

Upstream-Status: Backport

CVE-2015-3143

Bug: http://curl.haxx.se/docs/adv_20150422A.html
Reported-by: Paras Sethia
Signed-off-by: Daniel Stenberg <daniel@haxx.se>
Signed-off-by: Maxin B. John <maxin.john@enea.com>

Check if USE_NTLM is defined before using NTLM symbols

Signed-off-by: Jonathan David <jonathan.david@ni.com>
---
 lib/url.c | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/lib/url.c b/lib/url.c
index d3bb5e0..4df8d10 100644
--- a/lib/url.c
+++ b/lib/url.c
@@ -3183,8 +3183,12 @@ ConnectionExists(struct SessionHandle *data,
           continue;
       }
 
-      if((!(needle->handler->flags & PROTOPT_CREDSPERREQUEST)) ||
-         wantNTLMhttp) {
+      if((!(needle->handler->flags & PROTOPT_CREDSPERREQUEST))
+#if defined(USE_NTLM)
+	 || (wantNTLMhttp || check->ntlm.state != NTLMSTATE_NONE)
+#endif
+	)
+	{
         /* This protocol requires credentials per connection or is HTTP+NTLM,
            so verify that we're using the same name and password as well */
         if(!strequal(needle->user, check->user) ||
-- 
1.9.1

